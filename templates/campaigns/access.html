{% extends "base.html" %}
{% load static %}

{% block title %}{{ campaign.title }} | PLATAFORMA NR-1{% endblock %}

{% block extra_head %}
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/campaign.css' %}" />
{% endblock %}

{% block content %}
<div class="cpg-page">
  <div class="cpg-topbar">
    <span class="cpg-topbar__brand">{{ campaign.title }}</span>
    <div class="cpg-topbar__track">
      <div class="cpg-topbar__fill" style="width:10%"></div>
    </div>
    <span class="cpg-topbar__step">1 / 10</span>
  </div>

  <main class="campaign-access">
    <header class="cpg-header">
      <div class="cpg-header__badge">Etapa 1 de 10</div>
      <h1 class="cpg-header__title">Ferramenta de Indicador de Estresse</h1>
      <p class="cpg-header__sub">Este questionário é totalmente anônimo e contém perguntas sobre suas condições de trabalho. Sua opinião é essencial para melhorar o ambiente de trabalho.</p>
    </header>

    <section class="campaign-access__card">
      <div class="campaign-access__company">
        <strong>{{ company.name }}</strong>
        <p>CNPJ: {{ company.cnpj|default:"-" }}</p>
      </div>

      <div class="info-block info-block--success">
        <div class="info-block__icon" aria-hidden="true">✓</div>
        <div>
          <p class="info-block__title">Avaliação verificada</p>
          <p class="info-block__text">
            Esta avaliação faz parte de uma campanha oficial. Seu CPF será criptografado e utilizado
            apenas para validar que você respondeu apenas uma vez. A empresa não terá acesso ao seu CPF
            nem poderá identificar suas respostas individuais.
          </p>
        </div>
      </div>

      <div class="info-block info-block--info">
        <div class="info-block__icon" aria-hidden="true">ⓘ</div>
        <div>
          <p class="info-block__title">Garantia de anonimato</p>
          <p class="info-block__text">
            Todas as informações coletadas neste formulário são completamente anônimas. Seus dados pessoais
            não serão disponibilizados para a empresa. Utilizamos essas informações apenas para análises
            estatísticas agregadas que ajudarão a melhorar o ambiente de trabalho.
          </p>
          <p class="info-block__text">
            Esta avaliação tem como objetivo compreender melhor o ambiente de trabalho e identificar
            fatores de riscos psicossociais que possam impactar a saúde dos trabalhadores, contribuindo
            para a melhoria contínua das condições de trabalho, conforme determina a NR 01.
          </p>
        </div>
      </div>

      {% if messages %}
        <section style="margin-bottom:14px;">
          {% for message in messages %}
            <div class="notice{% if message.tags %} notice--{{ message.tags }}{% endif %}">{{ message }}</div>
          {% endfor %}
        </section>
      {% endif %}

      <form id="step-form" method="post" class="form-grid campaign-form" data-cpf-check-url="{% url 'campaigns-cpf-check' campaign.uuid %}" data-use-ghe="{% if use_ghe %}1{% else %}0{% endif %}" data-campaign-uuid="{{ campaign.uuid }}" data-step="1">
        {% csrf_token %}
        <input type="hidden" name="step" value="1" />
        <div class="form-field">
          <label for="cpf">
            <span class="label-required">CPF (Obrigatório)</span>
            <span class="label-meta">*</span>
          </label>
          <input id="cpf" name="cpf" required maxlength="14" placeholder="000.000.000-00" />
          <small class="field-error" data-cpf-error style="display:none;"></small>
        </div>
        <div class="form-field">
          <label for="first_name">Primeiro Nome <span class="label-meta">Opcional</span></label>
          <input id="first_name" name="first_name" placeholder="Seu nome" />
        </div>
        <div class="form-field">
          <label for="age"><span class="label-required">Idade</span> <span class="label-meta">*</span></label>
          <input id="age" name="age" type="number" min="1" required />
        </div>
        <div class="form-field">
          <label for="sex">Sexo</label>
          <select id="sex" name="sex">
            <option value="">Prefiro não informar</option>
            <option value="feminino">Feminino</option>
            <option value="masculino">Masculino</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        {% if use_ghe %}
          <div class="form-field">
            <label for="ghe_id"><span class="label-required">GHE</span> <span class="label-meta">*</span></label>
            <select id="ghe_id" name="ghe_id" required data-ghe-select data-departments-url="{% url 'campaigns-departments' campaign.uuid %}">
              <option value="">Selecione</option>
              {% for ghe in ghes %}
                <option value="{{ ghe.id }}">{{ ghe.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field">
            <label for="department_id"><span class="label-required">Cargo/Funcao</span> <span class="label-meta">*</span></label>
            <select id="department_id" name="department_id" required disabled data-department-select>
              <option value="">Selecione o GHE primeiro</option>
            </select>
          </div>
        {% else %}
          <div class="form-field">
            <label for="department_id"><span class="label-required">Setor</span> <span class="label-meta">*</span></label>
            <select id="department_id" name="department_id" required data-department-select data-job-functions-url="{% url 'campaigns-job-functions' campaign.uuid %}">
              <option value="">Selecione</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field">
            <label for="job_function_id"><span class="label-required">Cargo/Funcao</span> <span class="label-meta">*</span></label>
            <select id="job_function_id" name="job_function_id" required disabled data-job-function-select>
              <option value="">Selecione o setor primeiro</option>
            </select>
          </div>
        {% endif %}
        <div class="instructions-card">
          <p class="instructions-card__title">Instruções</p>
          <ul>
            <li>O questionário leva cerca de 10 minutinhos</li>
            <li>Marque apenas uma resposta por pergunta</li>
            <li>Suas respostas são completamente anônimas</li>
            <li>Em caso de dúvidas, entre em contato com seu supervisor</li>
          </ul>
        </div>
        <div class="form-actions">
          <button class="btn btn--primary" type="submit" data-start-button disabled>
            Começar Avaliação
            <span aria-hidden="true">→</span>
          </button>
        </div>
      </form>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/campaign_localstorage.js' %}"></script>
  <script>
    (function () {
      const gheSelect = document.querySelector('[data-ghe-select]');
      const departmentSelect = document.querySelector('[data-department-select]');
      const form = document.querySelector('form.campaign-form');
      const useGhe = form?.getAttribute('data-use-ghe') === '1';
      const departmentsUrl = gheSelect ? gheSelect.getAttribute('data-departments-url') : '';
      if (!useGhe || !gheSelect || !departmentSelect || !departmentsUrl) return;

      const setDepartmentState = (state) => {
        departmentSelect.disabled = Boolean(state.disabled);
        departmentSelect.innerHTML = `<option value="">${state.label}</option>`;
      };

      const loadDepartments = async (gheId) => {
        if (!gheId) {
          setDepartmentState({ disabled: true, label: 'Selecione o GHE primeiro' });
          return;
        }
        setDepartmentState({ disabled: true, label: 'Carregando...' });
        let payload = null;
        try {
          const response = await fetch(`${departmentsUrl}?ghe_id=${encodeURIComponent(gheId)}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });
          if (!response.ok) throw new Error('request_failed');
          payload = await response.json();
        } catch (err) {
          setDepartmentState({ disabled: true, label: 'Não foi possível carregar' });
          return;
        }

        const departments = Array.isArray(payload.departments) ? payload.departments : [];
        if (!departments.length) {
          setDepartmentState({ disabled: true, label: 'Nenhum setor disponível' });
          return;
        }
        departmentSelect.disabled = false;
        departmentSelect.innerHTML = [
          '<option value="">Selecione</option>',
          ...departments.map((dept) => `<option value="${dept.id}">${dept.name}</option>`),
        ].join('');
      };

      gheSelect.addEventListener('change', (event) => {
        loadDepartments(event.target.value);
      });

      if (gheSelect.value) {
        loadDepartments(gheSelect.value);
      } else {
        setDepartmentState({ disabled: true, label: 'Selecione o GHE primeiro' });
      }
    })();
  </script>
  <script>
    (function () {
      const form = document.querySelector('form.campaign-form');
      if (!form) return;
      const useGhe = form.getAttribute('data-use-ghe') === '1';
      if (useGhe) return;

      const departmentSelect = form.querySelector('[data-department-select]');
      const jobFunctionSelect = form.querySelector('[data-job-function-select]');
      const jobFunctionsUrl = departmentSelect ? departmentSelect.getAttribute('data-job-functions-url') : '';
      if (!departmentSelect || !jobFunctionSelect || !jobFunctionsUrl) return;

      const setJobFunctionState = (state) => {
        jobFunctionSelect.disabled = Boolean(state.disabled);
        jobFunctionSelect.innerHTML = `<option value="">${state.label}</option>`;
      };

      const loadJobFunctions = async (departmentId) => {
        if (!departmentId) {
          setJobFunctionState({ disabled: true, label: 'Selecione o setor primeiro' });
          return;
        }
        setJobFunctionState({ disabled: true, label: 'Carregando...' });
        let payload = null;
        try {
          const response = await fetch(`${jobFunctionsUrl}?department_id=${encodeURIComponent(departmentId)}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });
          if (!response.ok) throw new Error('request_failed');
          payload = await response.json();
        } catch (err) {
          setJobFunctionState({ disabled: true, label: 'Não foi possível carregar' });
          return;
        }

        const jobFunctions = Array.isArray(payload.job_functions) ? payload.job_functions : [];
        if (!jobFunctions.length) {
          setJobFunctionState({ disabled: true, label: 'Nenhuma função disponível' });
          return;
        }
        jobFunctionSelect.disabled = false;
        jobFunctionSelect.innerHTML = [
          '<option value="">Selecione</option>',
          ...jobFunctions.map((item) => `<option value="${item.id}">${item.name}</option>`),
        ].join('');
      };

      departmentSelect.addEventListener('change', (event) => {
        loadJobFunctions(event.target.value);
      });

      if (departmentSelect.value) {
        loadJobFunctions(departmentSelect.value);
      } else {
        setJobFunctionState({ disabled: true, label: 'Selecione o setor primeiro' });
      }
    })();
  </script>
  <script>
    (function () {
      const form = document.querySelector('form.campaign-form');
      if (!form) return;
      const useGhe = form.getAttribute('data-use-ghe') === '1';
      const cpfInput = form.querySelector('#cpf');
      const ageInput = form.querySelector('#age');
      const gheSelect = form.querySelector('#ghe_id');
      const departmentSelect = form.querySelector('#department_id');
      const jobFunctionSelect = form.querySelector('#job_function_id');
      const submitButton = form.querySelector('[data-start-button]');
      const errorEl = form.querySelector('[data-cpf-error]');
      const checkUrl = form.getAttribute('data-cpf-check-url') || '';

      let cpfIsAvailable = false;
      let cpfCheckInFlight = false;
      let lastCpfChecked = '';
      let debounceId = null;

      const setCpfError = (message) => {
        if (!errorEl) return;
        if (message) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
        } else {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
        }
      };

      const setButtonState = () => {
        const cpfDigits = (cpfInput.value || '').replace(/\D/g, '');
        const ageValue = Number(ageInput.value || 0);
        const gheValue = gheSelect ? (gheSelect.value || '') : '';
        const departmentValue = departmentSelect.value || '';
        const jobFunctionValue = jobFunctionSelect ? (jobFunctionSelect.value || '') : '';
        const basicsOkBase =
          cpfDigits.length === 11 &&
          Number.isFinite(ageValue) &&
          ageValue > 0;
        const basicsOk = useGhe
          ? basicsOkBase && gheValue && departmentValue && !departmentSelect.disabled
          : basicsOkBase && departmentValue && jobFunctionValue && !jobFunctionSelect.disabled;
        const ready = basicsOk && cpfIsAvailable && !cpfCheckInFlight;
        submitButton.disabled = !ready;
      };

      const checkCpf = async (cpfDigits) => {
        if (!checkUrl || cpfDigits.length !== 11) {
          cpfIsAvailable = false;
          setButtonState();
          return;
        }
        cpfCheckInFlight = true;
        setButtonState();
        try {
          const response = await fetch(`${checkUrl}?cpf=${encodeURIComponent(cpfDigits)}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });
          if (!response.ok) throw new Error('request_failed');
          const payload = await response.json();
          cpfIsAvailable = Boolean(payload.available);
          setCpfError(payload.available ? '' : (payload.message || 'CPF já utilizado.'));
        } catch (err) {
          cpfIsAvailable = false;
          setCpfError('Não foi possível validar o CPF agora.');
        } finally {
          cpfCheckInFlight = false;
          setButtonState();
        }
      };

      const scheduleCpfCheck = () => {
        const cpfDigits = (cpfInput.value || '').replace(/\D/g, '');
        setCpfError('');
        if (cpfDigits.length !== 11) {
          cpfIsAvailable = false;
          lastCpfChecked = '';
          setButtonState();
          return;
        }
        if (cpfDigits === lastCpfChecked) {
          setButtonState();
          return;
        }
        if (debounceId) clearTimeout(debounceId);
        debounceId = setTimeout(() => {
          lastCpfChecked = cpfDigits;
          checkCpf(cpfDigits);
        }, 350);
      };

      cpfInput.addEventListener('input', scheduleCpfCheck);
      ageInput.addEventListener('input', setButtonState);
      if (gheSelect) {
        gheSelect.addEventListener('change', setButtonState);
      }
      departmentSelect.addEventListener('change', setButtonState);
      if (jobFunctionSelect) {
        jobFunctionSelect.addEventListener('change', setButtonState);
      }

      setButtonState();
    })();
  </script>
{% endblock %}
