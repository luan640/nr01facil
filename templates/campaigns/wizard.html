{% extends "base.html" %}
{% load static %}

{% block title %}{{ campaign.title }} | PLATAFORMA NR-1{% endblock %}

{% block extra_head %}
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/campaign.css' %}" />
{% endblock %}

{% block content %}
<div class="cpg-page">
  <div class="cpg-topbar">
    <span class="cpg-topbar__brand">{{ campaign.title }}</span>
    <div class="cpg-topbar__track">
      <div class="cpg-topbar__fill" data-step-progress style="width:10%"></div>
    </div>
    <span class="cpg-topbar__step" data-step-badge>Etapa 1 de 10</span>
  </div>

  <main class="campaign-step" data-initial-step="{{ initial_step|default:1 }}" data-campaign-uuid="{{ campaign.uuid }}">
    <header class="cpg-header">
      <div class="cpg-header__badge">Ferramenta de Indicador de Estresse</div>
      <h1 class="cpg-header__title">{{ campaign.title }}</h1>
      <p class="cpg-header__sub">
        Este question√°rio √© totalmente an√¥nimo e cont√©m perguntas sobre suas condi√ß√µes de trabalho.
        Sua opini√£o √© essencial para melhorar o ambiente de trabalho.
      </p>
    </header>

    <section class="campaign-step__card">
      <div class="campaign-step__company">
        <strong>{{ company.name }}</strong>
        <p>CNPJ: {{ company.cnpj|default:"-" }}</p>
      </div>

      <form id="wizard-form" method="post" action="{% url 'campaigns-access' campaign.uuid %}" data-use-ghe="{% if use_ghe %}1{% else %}0{% endif %}" data-cpf-check-url="{% url 'campaigns-cpf-check' campaign.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="step" value="9" />
        <input type="hidden" name="local_payload" />

        <!-- ‚îÄ‚îÄ Step 1: Identity ‚îÄ‚îÄ -->
        <section class="wizard-step" data-step="1">
          {% if messages %}
            <section style="margin-bottom:14px;">
              {% for message in messages %}
                <div class="notice{% if message.tags %} notice--{{ message.tags }}{% endif %}">{{ message }}</div>
              {% endfor %}
            </section>
          {% endif %}

          <div class="info-block info-block--success">
            <div class="info-block__icon" aria-hidden="true">‚úì</div>
            <div>
              <p class="info-block__title">Avalia√ß√£o verificada</p>
              <p class="info-block__text">
                Esta avalia√ß√£o faz parte de uma campanha oficial. O CPF √© solicitado somente para controle
                de participa√ß√£o e n√£o ser√° exibido para a empresa.
              </p>
              <p class="info-block__text">
                Os dados s√£o tratados conforme a LGPD e utilizados apenas para garantir que cada pessoa
                responda uma √∫nica vez.
              </p>
            </div>
          </div>

          <div class="info-block info-block--info">
            <div class="info-block__icon" aria-hidden="true">‚ìò</div>
            <div>
              <p class="info-block__title">Garantia de anonimato</p>
              <p class="info-block__text">
                Suas respostas s√£o completamente an√¥nimas e analisadas apenas de forma agregada.
                Nenhuma resposta individual √© atribu√≠da a voc√™.
              </p>
            </div>
          </div>

          <div class="form-grid campaign-form">
            <div class="form-field">
              <label for="cpf">
                <span class="label-required">CPF (Obrigat√≥rio)</span>
                <span class="label-meta">*</span>
              </label>
              <input id="cpf" name="cpf" required maxlength="14" placeholder="000.000.000-00" />
              <small class="field-error" data-cpf-error style="display:none;"></small>
            </div>
            <div class="form-field">
              <label for="first_name">Primeiro Nome <span class="label-meta">Opcional</span></label>
              <input id="first_name" name="first_name" placeholder="Seu nome" />
            </div>
            <div class="form-field">
              <label for="age"><span class="label-required">Idade</span> <span class="label-meta">*</span></label>
              <input id="age" name="age" type="number" min="1" required />
            </div>
            <div class="form-field">
              <label for="sex">Sexo</label>
              <select id="sex" name="sex">
                <option value="">Prefiro n√£o informar</option>
                <option value="feminino">Feminino</option>
                <option value="masculino">Masculino</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            {% if use_ghe %}
              <div class="form-field">
                <label for="ghe_id"><span class="label-required">GHE</span> <span class="label-meta">*</span></label>
                <select id="ghe_id" name="ghe_id" required data-ghe-select data-departments-url="{% url 'campaigns-departments' campaign.uuid %}">
                  <option value="">Selecione</option>
                  {% for ghe in ghes %}
                    <option value="{{ ghe.id }}">{{ ghe.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label for="department_id"><span class="label-required">Cargo/Fun√ß√£o</span> <span class="label-meta">*</span></label>
                <select id="department_id" name="department_id" required disabled data-department-select>
                  <option value="">Selecione o GHE primeiro</option>
                </select>
              </div>
            {% else %}
              <div class="form-field">
                <label for="department_id"><span class="label-required">Setor</span> <span class="label-meta">*</span></label>
                <select id="department_id" name="department_id" required data-department-select data-job-functions-url="{% url 'campaigns-job-functions' campaign.uuid %}">
                  <option value="">Selecione</option>
                  {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label for="job_function_id"><span class="label-required">Cargo/Fun√ß√£o</span> <span class="label-meta">*</span></label>
                <select id="job_function_id" name="job_function_id" required disabled data-job-function-select>
                  <option value="">Selecione o setor primeiro</option>
                </select>
              </div>
            {% endif %}
            <div class="instructions-card">
              <p class="instructions-card__title">Instru√ß√µes</p>
              <ul>
                <li>O question√°rio leva cerca de 10 minutinhos</li>
                <li>Marque apenas uma resposta por pergunta</li>
                <li>Suas respostas s√£o completamente an√¥nimas</li>
                <li>Em caso de d√∫vidas, entre em contato com seu supervisor</li>
              </ul>
            </div>
          </div>
          <div class="question-actions">
            <span></span>
            <button class="btn btn--primary" type="button" data-next-step>Come√ßar Avalia√ß√£o ‚Üí</button>
          </div>
        </section>

        <!-- ‚îÄ‚îÄ Steps 2‚Äì8: Questions ‚îÄ‚îÄ -->
        {% for step in steps %}
          <section class="wizard-step" data-step="{{ step.step }}">
            <div class="question-section">
              <h2 class="question-section__title">
                <span aria-hidden="true">üìä</span> {{ step.section_title }}
              </h2>
              <p class="question-section__subtitle">{{ step.section_description }}</p>
            </div>

            {% for question in step.questions %}
              <div class="question-card">
                <div class="question-card__title-row">
                  <p class="question-card__title">{{ forloop.counter }}. {{ question }}</p>
                  <span class="question-card__hint" aria-hidden="true">i</span>
                </div>
                <div class="question-card__options">
                  {% for option in step.scale_options %}
                    <label class="question-option">
                      <input type="radio" name="step{{ step.step }}q{{ forloop.parentloop.counter }}" value="{{ option }}" />
                      <span>{{ option }}</span>
                    </label>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}

            <div class="question-actions">
              <button class="btn btn--ghost" type="button" data-prev-step>‚Üê Voltar</button>
              <button class="btn btn--primary" type="button" data-next-step>Pr√≥xima ‚Üí</button>
            </div>
          </section>
        {% endfor %}

        <!-- ‚îÄ‚îÄ Step 9: Comments ‚îÄ‚îÄ -->
        <section class="wizard-step" data-step="9">
          <div class="question-section">
            <h2 class="question-section__title">
              <span aria-hidden="true">üí¨</span> {{ step9.section_title|default:"Coment√°rios Adicionais" }}
            </h2>
            <p class="question-section__subtitle">
              {{ step9.section_description|default:"Gostaria de compartilhar algum coment√°rio adicional sobre sua experi√™ncia de trabalho?" }}
            </p>
          </div>

          <div class="comment-card">
            <p class="comment-card__title">Seus coment√°rios (opcional)</p>
            <textarea id="comments" name="comments" maxlength="1000" placeholder="Compartilhe suas observa√ß√µes..."></textarea>
            <p class="comment-card__footer">0/1000 caracteres</p>
          </div>

          <div class="question-actions">
            <button class="btn btn--ghost" type="button" data-prev-step>‚Üê Voltar</button>
            <button class="btn btn--primary" type="submit" data-finish>Finalizar Avalia√ß√£o ‚Üí</button>
          </div>
        </section>
      </form>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/campaign_wizard.js' %}"></script>
{% endblock %}
