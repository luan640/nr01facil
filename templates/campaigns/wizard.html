{% extends "base.html" %}
{% load static %}

{% block title %}{{ campaign.title }} | PLATAFORMA NR-1{% endblock %}

{% block extra_head %}
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
  <style>
    .campaign-step {
      max-width: 980px;
      margin: 32px auto 60px;
      width: 100%;
      padding: 0 16px;
    }
    .campaign-step__header {
      text-align: center;
      display: grid;
      gap: 10px;
      margin-bottom: 16px;
    }
    .campaign-step__icon {
      width: 34px;
      height: 34px;
      margin: 0 auto;
      border-radius: 12px;
      background: #e6efff;
      color: #2563eb;
      display: grid;
      place-items: center;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
    }
    .campaign-step__title {
      margin: 0;
      font-size: clamp(1.55rem, 2vw + 1rem, 2.2rem);
      line-height: 1.2;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .campaign-step__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 700;
      font-size: 0.82rem;
      width: fit-content;
      margin: 0 auto;
    }
    .campaign-step__lead {
      margin: 0 auto;
      max-width: 620px;
      color: var(--slate-600);
      font-size: 0.98rem;
    }
    .campaign-step__progress {
      height: 10px;
      border-radius: 999px;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      overflow: hidden;
      max-width: 560px;
      margin: 12px auto 0;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
    }
    .campaign-step__progress span {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #0f172a, #1e293b);
      border-radius: inherit;
    }
    .campaign-step__card {
      padding: 22px 22px 18px;
      max-width: 640px;
      margin: 0 auto;
    }
    .campaign-step__company {
      text-align: center;
      margin-bottom: 16px;
    }
    .campaign-step__company p {
      margin: 4px 0 0;
      color: var(--slate-600);
    }
    .question-section,
    .comment-section {
      display: grid;
      gap: 6px;
      margin-bottom: 12px;
    }
    .question-section__title,
    .comment-section__title {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
      color: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .question-section__subtitle,
    .comment-section__subtitle {
      margin: 0;
      color: #64748b;
      font-size: 0.88rem;
    }
    .question-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      background: #f8fbff;
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
    }
    .question-card__title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .question-card__title {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 700;
      color: #0f172a;
    }
    .question-card__options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.82rem;
      color: #475569;
    }
    .question-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .question-option input {
      accent-color: #2563eb;
    }
    .question-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .btn--ghost {
      background: #fff;
      border: 1px solid #e2e8f0;
      color: #0f172a;
    }
    .comment-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      background: #f8fbff;
      display: grid;
      gap: 10px;
    }
    .comment-card label {
      font-size: 0.88rem;
      font-weight: 700;
      color: #0f172a;
    }
    .comment-card textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border: 1px solid #dbeafe;
      border-radius: 10px;
      padding: 10px 12px;
      font: inherit;
      background: #fff;
    }
    .comment-card__footer {
      display: flex;
      justify-content: flex-end;
      color: #94a3b8;
      font-size: 0.78rem;
    }
    .info-block {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      margin-bottom: 12px;
      background: #f8fafc;
    }
    .info-block__icon {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-size: 0.9rem;
      font-weight: 800;
    }
    .info-block__title {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .info-block__text {
      margin: 6px 0 0;
      color: #334155;
      font-size: 0.9rem;
    }
    .info-block--success {
      background: #ecfdf3;
      border-color: #bbf7d0;
    }
    .info-block--success .info-block__icon {
      background: #dcfce7;
      color: #166534;
    }
    .info-block--info {
      background: #eff6ff;
      border-color: #bfdbfe;
    }
    .info-block--info .info-block__icon {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .wizard-step {
      display: none;
    }
    .wizard-step.is-active {
      display: block;
    }
    @media (max-width: 720px) {
      .campaign-step__card {
        padding: 18px 16px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<main class="campaign-step" data-initial-step="{{ initial_step|default:1 }}" data-campaign-uuid="{{ campaign.uuid }}">
  <header class="campaign-step__header">
    <div class="campaign-step__icon" aria-hidden="true">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 12c2.76 0 5-2.3 5-5.1C17 4.1 14.76 2 12 2S7 4.1 7 6.9C7 9.7 9.24 12 12 12Z" stroke="currentColor" stroke-width="1.6" />
        <path d="M4 21c0-4.2 3.6-7.6 8-7.6s8 3.4 8 7.6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
      </svg>
    </div>
    <h1 class="campaign-step__title">Ferramenta de Indicador de Estresse</h1>
    <div class="campaign-step__badge" data-step-badge>Etapa 1 de 10</div>
    <p class="campaign-step__lead">
      Este question√°rio √© totalmente an√¥nimo e cont√©m perguntas sobre suas condi√ß√µes de trabalho.
      Sua opini√£o √© essencial para melhorar o ambiente de trabalho.
    </p>
    <div class="campaign-step__progress" role="presentation">
      <span data-step-progress style="width: 10%;"></span>
    </div>
  </header>

  <section class="card campaign-step__card">
    <div class="campaign-step__company">
      <strong>{{ company.name }}</strong>
      <p>CNPJ: {{ company.cnpj|default:"-" }}</p>
    </div>

    <form id="wizard-form" method="post" action="{% url 'campaigns-access' campaign.uuid %}" data-use-ghe="{% if use_ghe %}1{% else %}0{% endif %}" data-cpf-check-url="{% url 'campaigns-cpf-check' campaign.uuid %}">
      {% csrf_token %}
      <input type="hidden" name="step" value="9" />
      <input type="hidden" name="local_payload" />

      <section class="wizard-step" data-step="1">
        {% if messages %}
          <section class="stack-gap" style="margin-bottom: 16px;">
            {% for message in messages %}
              <div class="notice{% if message.tags %} notice--{{ message.tags }}{% endif %}">{{ message }}</div>
            {% endfor %}
          </section>
        {% endif %}
        <div class="info-block info-block--success">
          <div class="info-block__icon" aria-hidden="true">‚úì</div>
          <div>
            <p class="info-block__title">Avalia√ß√£o verificada</p>
            <p class="info-block__text">
              Esta avalia√ß√£o faz parte de uma campanha oficial. O CPF √© solicitado somente para controle
              de participa√ß√£o e n√£o ser√° exibido para a empresa.
            </p>
            <p class="info-block__text">
              Os dados s√£o tratados conforme a LGPD e utilizados apenas para garantir que cada pessoa
              responda uma √∫nica vez.
            </p>
          </div>
        </div>

        <div class="info-block info-block--info">
          <div class="info-block__icon" aria-hidden="true">‚ìò</div>
          <div>
            <p class="info-block__title">Garantia de anonimato</p>
            <p class="info-block__text">
              Suas respostas s√£o completamente an√¥nimas e analisadas apenas de forma agregada.
              Nenhuma resposta individual √© atribu√≠da a voc√™.
            </p>
          </div>
        </div>
        <div class="form-grid campaign-form">
          <div class="form-field">
            <label for="cpf">
              <span class="label-required">CPF (Obrigat√≥rio)</span>
              <span class="label-meta">*</span>
            </label>
            <input id="cpf" name="cpf" required maxlength="14" placeholder="000.000.000-00" />
            <small class="field-error" data-cpf-error style="display:none;"></small>
          </div>
          <div class="form-field">
            <label for="first_name">Primeiro Nome <span class="label-meta">Opcional</span></label>
            <input id="first_name" name="first_name" placeholder="Seu nome" />
          </div>
          <div class="form-field">
            <label for="age"><span class="label-required">Idade</span> <span class="label-meta">*</span></label>
            <input id="age" name="age" type="number" min="1" required />
          </div>
          <div class="form-field">
            <label for="sex">Sexo</label>
            <select id="sex" name="sex">
              <option value="">Prefiro n√£o informar</option>
              <option value="feminino">Feminino</option>
              <option value="masculino">Masculino</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          {% if use_ghe %}
            <div class="form-field">
              <label for="ghe_id"><span class="label-required">GHE</span> <span class="label-meta">*</span></label>
              <select id="ghe_id" name="ghe_id" required data-ghe-select data-departments-url="{% url 'campaigns-departments' campaign.uuid %}">
                <option value="">Selecione</option>
                {% for ghe in ghes %}
                  <option value="{{ ghe.id }}">{{ ghe.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label for="department_id"><span class="label-required">Cargo/Fun√ß√£o</span> <span class="label-meta">*</span></label>
              <select id="department_id" name="department_id" required disabled data-department-select>
                <option value="">Selecione o GHE primeiro</option>
              </select>
            </div>
          {% else %}
            <div class="form-field">
              <label for="department_id"><span class="label-required">Setor</span> <span class="label-meta">*</span></label>
              <select id="department_id" name="department_id" required data-department-select data-job-functions-url="{% url 'campaigns-job-functions' campaign.uuid %}">
                <option value="">Selecione</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label for="job_function_id"><span class="label-required">Cargo/Funcao</span> <span class="label-meta">*</span></label>
              <select id="job_function_id" name="job_function_id" required disabled data-job-function-select>
                <option value="">Selecione o setor primeiro</option>
              </select>
            </div>
          {% endif %}
          <div class="instructions-card">
            <strong>Instru√ß√µes:</strong>
            <ul>
              <li>O question√°rio leva cerca de 10 minutinhos</li>
              <li>Marque apenas uma resposta por pergunta</li>
              <li>Suas respostas s√£o completamente an√¥nimas</li>
              <li>Em caso de d√∫vidas, entre em contato com seu supervisor</li>
            </ul>
          </div>
        </div>
        <div class="question-actions">
          <span></span>
          <button class="btn btn--primary" type="button" data-next-step>Come√ßar Avalia√ß√£o ‚Üí</button>
        </div>
      </section>

      {% for step in steps %}
        <section class="wizard-step" data-step="{{ step.step }}">
          <div class="question-section">
            <h2 class="question-section__title">
              <span aria-hidden="true">üìä</span> {{ step.section_title }}
            </h2>
            <p class="question-section__subtitle">
              {{ step.section_description }}
            </p>
          </div>

          {% for question in step.questions %}
            <div class="question-card">
              <div class="question-card__title-row">
                <p class="question-card__title">{{ forloop.counter }}. {{ question }}</p>
              </div>
              <div class="question-card__options">
                {% for option in step.scale_options %}
                  <label class="question-option">
                    <input type="radio" name="step{{ step.step }}q{{ forloop.parentloop.counter }}" value="{{ option }}" />
                    <span>{{ option }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endfor %}

          <div class="question-actions">
            <button class="btn btn--ghost" type="button" data-prev-step>‚Üê Voltar</button>
            <button class="btn btn--primary" type="button" data-next-step>Pr√≥xima ‚Üí</button>
          </div>
        </section>
      {% endfor %}

      <section class="wizard-step" data-step="9">
        <div class="comment-section">
          <h2 class="comment-section__title">
            <span aria-hidden="true">*</span> {{ step9.section_title|default:"Coment√°rios Adicionais" }}
          </h2>
          <p class="comment-section__subtitle">
            {{ step9.section_description|default:"Gostaria de compartilhar algum coment√°rio adicional sobre sua experi√™ncia de trabalho?" }}
          </p>
        </div>
        <div class="comment-card">
          <label for="comments">Seus coment√°rios (opcional)</label>
          <textarea id="comments" name="comments" maxlength="1000" placeholder="Compartilhe suas observa√ß√µes..."></textarea>
          <div class="comment-card__footer">0/1000 caracteres</div>
        </div>
        <div class="question-actions">
          <button class="btn btn--ghost" type="button" data-prev-step>‚Üê Voltar</button>
          <button class="btn btn--primary" type="submit" data-finish>Finalizar Avalia√ß√£o ‚Üí</button>
        </div>
      </section>
    </form>
  </section>
</main>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/campaign_wizard.js' %}"></script>
{% endblock %}
